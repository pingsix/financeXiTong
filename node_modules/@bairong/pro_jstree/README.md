# @bairong/jstree

这个权限树适用于angular工程化项目，因为该树依赖webpack作为包管理工具，该树仅在原始树上做些整理和依赖更改，在开发上引用更清晰。

## Getting Started

使用依赖文件:
 1. 该组件依赖jquery，版本1.9.0或更高版本；
 2. 保存树或获取已经更改过的权限时需要依赖treeTransform.js；
 3. 依赖原始权限数据（遵循数据格式规范）；

 html 需创建一个承载树的容器元素
```html
 <div id="dtree"></div>
```
 
 
 js 依赖
```js
import $ from "jquery";

import source from '../**/powerResources';

import jstree from 'jstree';

import treeTransform from "../**/treeTransform";
```




### develope usage

创建原始权限数据（如果不和操作权限树写在一个文件里，可以单独穿件个powerResources.js文件）
```js
module.exports = [
	{id:'j1_1',text:'收益明细',children:[
		{id:'j1_2',text:'图表展示',href:'earnings/chart'},
		{id:'j1_3',text:'分润情况',href:'earnings/splitting'},
	]},
	{id:'j1_4',text:'账务信息',children:[
		{id:'j1_5',text:'个人账务信息',href:'financial/personage'},
		{id:'j1_6',text:'产品账务信息',href:'financial/productoin'},
		{id:'j1_7',text:'合作机构账务信息',href:'financial/parent'}
	]},
	{id:'j1_8',text:'配置中心',children:[
		{id:'j1_9',text:'产品配置',href:'configuration/production'},
	]},
	{id:'j1_10',text:'用户管理',children:[
		{id:'j1_11',text:'用户管理',href:'manager/user'},
		{id:'j1_12',text:'角色管理',href:'manager/role'},
	]}
];	
```


渲染权限树

*创建渲染和保存权限方法
	
	
```js
	/**
	 * @param[current]  获取被编辑过的权限数据\（如果没有的话可以使用原始数据\）
	 * @param[source]   原始权限数据
	 */
	function render(current,source){
        source = jstree.resetSource(source);     //调用权限树的resetSource方法，重置源数据
        current = jstree.resetCurrent(current);  //调用权限树的resetCurrent方法，重置当前数据
        source = jstree.mix(source,current);	 //调用权限树的mix方法，生成最终渲染需要的数据
			
        var selectNodes = [],d;
        $('#dtree').jstree(jstree.config(source));
        d = $('#dtree').jstree(true);
        $('#dtree').bind('loaded.jstree',function(e){
            d.open_all();
        })
        $('#btnSave').bind('click',function(e){
            if(!service.verifySbumit($scope,d)) return;
            e.preventDefault();
            e.stopPropagation();
            d.open_all();
            selectNodes = d.get_selected();
            d.delete_node(selectNodes);
                
            saveEmit(d);
        });
    }
	
	
	
	//保存新建或编辑权限
	function saveEmitter(d){
        var url,
            params1 = {};
		if(onParams.no && onParams.no == '10'){  
			url = '*.do';   					//新建接口
			params1 = {
				roles : treeTransform.tree2ids(JSON.stringify(d.get_json()))
			}
		}else{
			url = '*.do';                       //编辑接口
			params1={
			    roles: treeTransform.tree2ids(JSON.stringify(d.get_json()))
			};
		}
		service.saveRole(url,params1)
    }
```	
	
	
---	
# 创建treeTransform脚本文件

	treeTransform.js 主要做了对数据的处理，保存时对复杂的数据进行删减，只保存叶节点的索引，保存到数据库。还有恢复具有渲染功能的数据，一般在需要展示权限的地方用到，依赖原始权限数据；

```js
/**
 * @param ids:string ,source:Array
 */
function ids2tree(ids,source){
	if(source){
		var source = JSON.parse(JSON.stringify(source));
	}else{
		console.log('--> no source!');
		return;
	}
	if(typeof ids === 'string'){
		ids = JSON.parse(ids);
		if(!Array.isArray(ids)) return;
	};
	source.forEach(function(v){
		var isPassArr = [];
		v.children.forEach(function(item,index,arr){
			var isPss = ids.some(function(k){
							if(item.id === k){
								return true;
							}else{
								return false;
							}
						})
			if(isPss){
				isPassArr.push(item)
			}
		})
		v.children = isPassArr;
	})
	var newSource = [];
	source.forEach(function(v){
		if(v.children.length){
			newSource.push(v)
		}
	})
	return newSource;
}
		
/**
 * @param {Array} tree
 */
function tree2ids(tree){
	var ids = [];
	if(typeof tree === 'string'){
		tree = JSON.parse(tree);
	}
	else{
	}
	//删除父节点id						
	tree.forEach(function(v){
		if(v.id){
			delete v.id;
		}
	})
	getIds(tree);
	function getIds(tree){
		var tree2;
		if(typeof tree === 'string'){
			tree2 = JSON.parse(tree);
		}else{
			tree2 = tree;
		}
		tree2.forEach(function(v){
			if(v.id){
				if(ids.indexOf(v.id) !== -1) return;
				ids.push(v.id);
			}
			if(v.children && v.children.length){
				v.children.forEach(function(k,index,arr){
					getIds(arr);
				})
			}
		})
	}
	return JSON.stringify(ids);
}



export default {
			ids2tree : ids2tree,
			tree2ids : tree2ids,
			
		}
```
	
